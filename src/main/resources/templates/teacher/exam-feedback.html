<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/header :: head}"></head>

<body class="bg-white">

<style>
  .border-success {
    border-width: 4px !important;
  }

  .border-danger {
    border-width: 4px !important;
  }

  .bold-text {
    font-weight: bold;
  }

  .auto-resize {
    font-size: 18px;
  }
</style>

<!-- --------------------------- [FRAGMENT : ìƒë‹¨ ë„¤ì´ê²Œì´ì…˜ë°”]  ------------------------------------->
<div th:replace="~{fragments/top-nav :: top-nav}"></div>

<div id="layoutSidenav">
  <div id="layoutSidenav_nav">
  </div>
  <div id="layoutSidenav_content">
    <main>

      <!-- --------------------------- [FRAGMENT : ë°°ë„ˆ]  ------------------------------------->
      <div th:replace="~{fragments/top-banner :: top-banner}"></div>

      <!-- --------------------------- [ì¤‘ì•™ : ì»¨í…ì¸  START]  ------------------------------------->

      <div class="container-xl px-4 mt-n10">
        <!-- Wizard card example with navigation-->
        <div class="card">
          <div class="card-header border-bottom">
            <!-- Wizard navigation-->
            <div class="nav nav-pills nav-justified flex-column flex-xl-row nav-wizard">

              <!-- Wizard navigation item 1-->
              <a href="#wizard1" class="nav-item nav-link active">
                <div class="wizard-step-icon">1</div>
                <div class="wizard-step-text">
                  <div class="wizard-step-text-name">í•™ìƒ ì‹œí—˜ ê²°ê³¼ í™•ì¸</div>
                  <div class="wizard-step-text-details">í•™ìƒì´ ì œì¶œí•œ ì‹œí—˜ ë‚´ìš©ì„ í™•ì¸í•©ë‹ˆë‹¤.</div>
                </div>
              </a>

              <!-- Wizard navigation item 2 -->
              <a href="#wizard2" class="nav-item nav-link">
                <div class="wizard-step-icon">2</div>
                <div class="wizard-step-text">
                  <div class="wizard-step-text-name">í”¼ë“œë°± ì‘ì„±</div>
                  <div class="wizard-step-text-details">ì œì¶œí•œ ì‹œí—˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í”¼ë“œë°±ì„ ì‘ì„±í•©ë‹ˆë‹¤.</div>
                </div>
              </a>

              <!-- Wizard navigation item 3 -->
              <a href="#wizard3" class="nav-item nav-link">
                <div class="wizard-step-icon">3</div>
                <div class="wizard-step-text">
                  <div class="wizard-step-text-name">í•™ìƒ ìˆ˜ì¤€ í‰ê°€</div>
                  <div class="wizard-step-text-details">í•™ìƒì˜ ìˆ˜ì¤€ì„ í‰ê°€í•©ë‹ˆë‹¤.</div>
                </div>
              </a>

              <!-- Wizard navigation item 4-->
              <a href="#wizard4" class="nav-item nav-link">
                <div class="wizard-step-icon">4</div>
                <div class="wizard-step-text">
                  <div class="wizard-step-text-name">ì œì¶œí•˜ê¸°</div>
                  <div class="wizard-step-text-details">ì‘ì„±í•œ ë‚´ìš©ì„ ì œì¶œí•©ë‹ˆë‹¤.</div>
                </div>
              </a>
            </div>
          </div>

          <div class="card-body">
            <div class="tab-content" id="cardTabContent">

              <!-- Wizard tab pane item 1 -->
              <div id="wizard1" class="tab-pane py-1 fade show active" role="tabpanel"
                   aria-labelledby="wizard1-tab">
                <h2>í•™ìƒ ì‹œí—˜ ê²°ê³¼ í™•ì¸</h2>
                <p style="font-size: 20px; font-weight: bold; margin-bottom: 8px; color:black">
                  ì‹œí—˜ ì œëª©: <strong th:text="${examTitle}"></strong>
                </p>
                <div class="row">
                  <div class="col-lg-12">
                    <div id="questions-container" class="mt-4">
                      <!-- ì§ˆë¬¸ë“¤ì´ ì´ê³³ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-center mb-3">
                  <button class="btn btn-primary" type="button" id="exam-check-done-btn"
                          onclick="handleCheckButton()">
                    í™•ì¸ì™„ë£Œ
                  </button>
                </div>
              </div>

              <!-- Wizard tab pane item 2 -->
              <div id="wizard2" class="tab-pane py-1 fade" role="tabpanel"
                   aria-labelledby="wizard2-tab">
                <h2>í”¼ë“œë°± ì‘ì„±</h2>
                <!-- í”¼ë“œë°± ì‘ì„± & GPT ì¶”ì²œ -->
                <div class="row">
                  <div class="col-lg-8">
                    <div class="card">
                      <div class="card-header">
                        <h1>ì„ ìƒë‹˜ í”¼ë“œë°±</h1>
                      </div>

                      <div class="card-body mb-3 justify-content-center">
                        <form>
                          <textarea id="feedbackTextarea" class="form-control"
                                    style="font-size:16px" rows="15"></textarea>
                          <div class="d-flex justify-content-center mt-4 mb-3">
                            <button id="feedbackButton" class="btn btn-primary" type="button"
                                    onclick="handleFeedbackButton()">í”¼ë“œë°± ì €ì¥
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- Chat GPT ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ -->
                  <div class="col-lg-4">
                    <div class="nav-sticky">
                      <div class="card">
                        <div class="card-header">
                          <img th:src="@{/assets/img/gpt_icon.png}" height="35">
                        </div>
                        <div class="card-body mb-3 justify-content-center">
                          <!-- ë‚œì´ë„ ì„ íƒ íƒ­ ì¶”ê°€ -->
                          <ul class="nav nav-tabs" id="difficultyTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                              <a class="nav-link active" id="mild-tab" data-bs-toggle="tab"
                                 href="#mild" role="tab" aria-controls="mild" aria-selected="true"
                                 style="color:yellowgreen; font-weight:bold;">ìˆœí•œë§›</a>
                            </li>
                            <li class="nav-item" role="presentation">
                              <a class="nav-link" id="medium-tab" data-bs-toggle="tab"
                                 href="#medium" role="tab" aria-controls="medium"
                                 aria-selected="false" style="color:saddlebrown; font-weight:bold;">ë³´í†µë§›ğŸŒ¶</a>
                            </li>
                            <li class="nav-item" role="presentation">
                              <a class="nav-link" id="hard-tab" data-bs-toggle="tab" href="#hard"
                                 role="tab" aria-controls="hard" aria-selected="false"
                                 style="color:mediumvioletred; font-weight:bold;">ë§¤ìš´ë§›ğŸŒ¶ğŸŒ¶</a>
                            </li>
                            <li class="nav-item" role="presentation">
                              <a class="nav-link" id="hell-tab" data-bs-toggle="tab" href="#hell"
                                 role="tab" aria-controls="hard" aria-selected="false"
                                 style="color:red; font-weight:bold;">í­íƒ„ë§›ï¸ğŸŒ¶ğŸŒ¶ğŸŒ¶</a>
                            </li>
                          </ul>

                          <form id="gpt-form">
                            <textarea id="gpt-response" class="form-control" rows="20"
                                      style="font-size: 16px;" readonly></textarea>
                            <br>
                            <button type="button" class="btn btn-success" id="gpt-request-btn">GPTì—ê²Œ
                              ì¶”ì²œë°›ê¸°
                            </button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Wizard tab pane item 3 -->
              <div id="wizard3" class="tab-pane py-1 fade" role="tabpanel"
                   aria-labelledby="wizard3-tab">
                <h2>í•™ìƒ ìˆ˜ì¤€ í‰ê°€</h2>
                <!-- í•´ë‹¹ ì„¹ì…˜ì— í•„ìš”í•œ ì¶”ê°€ ë‚´ìš© ì¶”ê°€ -->
              </div>

              <!-- Wizard tab pane item 4 -->
              <div id="wizard4" class="tab-pane py-1 fade" role="tabpanel"
                   aria-labelledby="wizard4-tab">
                <h2>ì œì¶œí•˜ê¸°</h2>
                <!-- ë‚´ìš© ì¶”ê°€ -->
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- --------------------------- [ì¤‘ì•™ : ì»¨í…ì¸  END]  ------------------------------------->

    </main>

    <!-- --------------------------- [FRAGMENT : í•˜ë‹¨] ------------------------------------->
    <footer th:replace="~{fragments/footer :: footer}"></footer>

  </div>
</div>

<!-- ê³µí†µ <script> í¬í•¨ -->
<div th:replace="~{fragments/scripts :: scripts}"></div>

<!-- jQuery (í•„ìš”í•œ ê²½ìš°) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
  function handleCheckButton() {
    const examConfirmutton = document.getElementById('exam-check-done-btn');

    examConfirmutton.innerText = 'âœ…';
    examConfirmutton.classList.remove('btn-primary');
    examConfirmutton.classList.add('btn-success');

    examConfirmutton.disabled = true;
  }

  function handleFeedbackButton() {
    const feedbackTextarea = document.getElementById('feedbackTextarea');
    const feedbackButton = document.getElementById('feedbackButton');
    feedbackTextarea.readOnly = true;
    feedbackButton.innerText = 'âœ…';
    feedbackButton.classList.remove('btn-primary');
    feedbackButton.classList.add('btn-success');
    feedbackButton.disabled = true;
  }

  // JavaScript ë³€ìˆ˜ì— Thymeleaf ë°ì´í„°ë¥¼ í• ë‹¹
  const examSeq = /*[[${examSeq}]]*/ null;
  const teacherQuestions = /*[(${teacherQuestions})]*/ [];
  const lectureSubjects = /*[(${lectureSubjects})]*/ [];

  document.addEventListener('DOMContentLoaded', function () {
    var triggerTabList = [].slice.call(document.querySelectorAll('.nav-wizard a'));

    triggerTabList.forEach(function (triggerEl) {
      triggerEl.addEventListener('click', function (event) {
        event.preventDefault();

        // ëª¨ë“  íƒ­ì˜ í™œì„±í™” ìƒíƒœë¥¼ ì´ˆê¸°í™”
        triggerTabList.forEach(function (el) {
          el.classList.remove('active');
        });
        // í´ë¦­í•œ íƒ­ì„ í™œì„±í™”
        triggerEl.classList.add('active');

        // ëª¨ë“  íƒ­ ë‚´ìš© ë¹„í™œì„±í™”
        var tabContentList = document.querySelectorAll('.tab-pane');
        tabContentList.forEach(function (content) {
          content.classList.remove('show', 'active');
        });

        // í´ë¦­í•œ íƒ­ì— í•´ë‹¹í•˜ëŠ” ë‚´ìš© í™œì„±í™”
        var target = document.querySelector(triggerEl.getAttribute('href'));
        if (target) {
          target.classList.add('show', 'active');
          target.scrollIntoView({behavior: 'smooth', block: 'start'});
        }
      });
    });

    // ì§ˆë¬¸ ë°ì´í„°ë¥¼ ë Œë”ë§í•˜ëŠ” ë¶€ë¶„ ì¶”ê°€
    const questionsContainer = document.getElementById('questions-container');

    teacherQuestions.forEach((question, index) => {
      // ì§ˆë¬¸ ë²ˆí˜¸
      const questionCount = index + 1;

      // ì •ë‹µ ì—¬ë¶€ì— ë”°ë¥¸ ê¸€ì”¨ ìƒ‰ìƒ ê²°ì •
      const questionClass = question.correctAnswer === question.studentAnswer ? 'text-success'
          : 'text-danger';

      // ê° ì§ˆë¬¸ì˜ HTML êµ¬ì¡°
      const questionHTML = `
    <div class="card mb-4 question-set" id="question-${questionCount}">
        <div class="card-header d-flex justify-content-between ${questionClass}">
            <strong> ë¬¸ì œ ${questionCount} </strong>
        </div>
        <div class="card-body">
            <form>
                <div class="mb-3">
                    <label class="small mb-1"><b>ë¬¸ì œ ë‚´ìš©</b></label>
                    <textarea class="form-control auto-resize question-direction" rows="1" disabled>${question.direction}</textarea>
                </div>
                <div class="mb-0">
                    ${question.choices.map((choice, idx) => `
                        <div class="form-check mb-2 d-flex align-items-center
                            ${(idx + 1 === question.correctAnswer ? 'border border-success' : '')}
                            ${(idx + 1 === question.studentAnswer && idx + 1
      !== question.correctAnswer ? 'border border-danger' : '')}"
                           style="
                                ${(idx + 1 === question.correctAnswer) ? 'border: 5px solid green;'
          : ''}
                                ${(idx + 1 === question.studentAnswer && idx + 1
          !== question.correctAnswer)
          ? 'border: 5px solid red;' : ''}
                            ">
                            <label class="form-check-label me-3 ${idx + 1 === question.correctAnswer
          ? 'bold-text' : ''}">${idx + 1}</label>
                            <textarea class="form-control auto-resize ${idx + 1
      === question.correctAnswer ? 'bold-text' : ''}" rows="1" disabled>${choice}</textarea>
                        </div>
                    `).join('')}
                </div>
                <div class="mb-3">
                    <label class="small mb-1"><b>ì •ë‹µ</b></label>
                    <select class="form-control correct-answer" disabled>
                        ${question.choices.map((_, idx) => `
                            <option value="${idx + 1}" ${idx + 1 === question.correctAnswer
          ? 'selected' : ''}>${idx + 1}</option>
                        `).join('')}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="small mb-1"><b>ì¶œì œì˜ë„</b></label>
                    <textarea class="form-control auto-resize question-intent" rows="1" disabled>${question.intent}</textarea>
                </div>
            </form>
        </div>
    </div>
`;

      // ì»¨í…Œì´ë„ˆì— ì¶”ê°€
      questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
    });

    // ìƒˆë¡œ ì¶”ê°€ëœ textareaì— ëŒ€í•´ autoResize ì„¤ì •
    autoResize();
  });

  function autoResize() {
    $('textarea.auto-resize').each(function () {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    }).on('input', function () {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  }

  // ì´ˆê¸° ì„¤ì •
  autoResize();
</script>
<script th:inline="javascript">

  // teacherQuestionsì—ì„œ teacherQuestionSeqë¥¼ '-'ë¡œ ì´ì–´ë¶™ì—¬ì„œ ìš”ì²­ì— ì‚¬ìš©í•  ë¬¸ìì—´ ìƒì„±
  const teacherQuestionSeqsStr = teacherQuestions.map(q => q.teacherQuestionSeq).join('-');

  // í•™ìƒ í•™ë…„ ì •ë³´ ë° í•„ìš” ë°ì´í„° í• ë‹¹
  const studentGrade = '[(${studentGrade})]';

  // ë‚œì´ë„ì— ë”°ë¼ angryIndexë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
  function getAngryIndex(activeTabId) {
    switch (activeTabId) {
      case 'mild-tab':
        return 'ìˆœí•œë§›';
      case 'medium-tab':
        return 'ë³´í†µë§›';
      case 'hard-tab':
        return 'ë§¤ìš´ë§›';
      case 'hell-tab':
        return 'í­íƒ„ë§›';
      default:
        return 'ìˆœí•œë§›'; // ê¸°ë³¸ê°’ ì„¤ì •
    }
  }

  // GPTì—ê²Œ ì¶”ì²œë°›ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#gpt-request-btn').on('click', function () {
    const activeTab = $('#difficultyTabs .nav-link.active').attr('id');
    const angryIndex = getAngryIndex(activeTab); // ë‚œì´ë„ì— ë§ëŠ” angryIndex ì„¤ì •

    const $button = $(this);
    $button.text('ìƒì„±ì¤‘...').removeClass('btn-success').addClass('btn-danger').prop('disabled', true);

    // SSE ìš”ì²­ URL êµ¬ì„±
    const url = `/api/teacher/gpt/recommendation/feedback?studentGrade=${encodeURIComponent(
        studentGrade)}&teacherQuestionSeqsStr=${encodeURIComponent(
        teacherQuestionSeqsStr)}&angryIndex=${encodeURIComponent(angryIndex)}`;
    const $responseArea = $('#gpt-response');
    $responseArea.val(''); // ê¸°ì¡´ ë‚´ìš©ì„ ì´ˆê¸°í™”

    const eventSource = new EventSource(url);
    let renderChain = $.Deferred().resolve();

    // SSE ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
    eventSource.onmessage = function (event) {
      if (event.data === "[englebee-finished]") {
        eventSource.close();
        renderChain.done(() => {
          $button.text('GPTì—ê²Œ ì¶”ì²œë°›ê¸°').removeClass('btn-danger').addClass('btn-success').prop(
              'disabled', false);
        });
        return;
      }
      const modifiedMessage = event.data.replace('ã…¤', ' ');
      renderChain = renderChain.then(() => renderMessage(modifiedMessage));
    };

    // ë©”ì‹œì§€ ë Œë”ë§ í•¨ìˆ˜
    function renderMessage(message) {
      const deferred = $.Deferred();
      let i = 0;

      function renderNextChar() {
        if (i < message.length) {
          $responseArea.val($responseArea.val() + message[i]);
          $responseArea.scrollTop($responseArea[0].scrollHeight);
          i++;
          setTimeout(renderNextChar, 5);
        } else {
          deferred.resolve();
        }
      }

      renderNextChar();
      return deferred.promise();
    }

    // SSE ì—ëŸ¬ ì²˜ë¦¬
    eventSource.onerror = function (error) {
      eventSource.close();
      $button.text('GPTì—ê²Œ ì¶”ì²œë°›ê¸°').removeClass('btn-danger').addClass('btn-success').prop('disabled',
          false);
    };
  });
</script>


</body>
</html>
